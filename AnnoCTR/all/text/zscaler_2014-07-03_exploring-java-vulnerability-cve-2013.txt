Exploring The Java Vulnerability (CVE-2013-2465) Used In The Fiesta EK
July 03, 2014
While going through our daily analysis this month, we came across several **Fiesta Exploit Kit** attacks.
Although this EK first emerged in August 2013, the authors have constantly updated their exploitation code to evade detection.
It mostly targets known vulnerabilities in Java and Microsoft Silverlight for exploitation.
We identified a .jar file attached to a FiestaEK landing page and on performing some manual code analysis, found it to be exploiting the **CVE-2013-2465**Java vulnerability.
There isn’t much detail available regarding how the exploit actually occurs, so we really wanted to walk through each step of the attack and explain each step in detail.
The code as you will see is constructed in a way to avoid static detection using string searches or Yara scans.
**Jar file details:**
MD5 hash: ed2e61b302c6ed7ccb3699cc33d23f71
VirusTotal report: [16/54](https://www.virustotal.com/#/file/92d1bcb375d26a8d55e117b79ae3d41fc2a6cb4e55688c7815b0e732f099b8fc/analysis/1403775030) 
The malicious jar file can also be downloaded from here (hxxp://www.malware-traffic-analysis.net/2014/06/07/2014-06-07-Fiesta-EK-malware.zip).
It contains the following six classes.
![](data:image/png;base64,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)
The malware author tries to complicate the program by constructing strings using String.replace().
For eg: 
[![](/cdn-cgi/image/format=auto/sites/default/files/images/blogs/-lJ7N6FYJcc0/U7Uf3Cye1wI/AAAAAAAAAE8/EG46W1D_ea8/s1600/3.png)](/sites/default/files/images/blogs/-lJ7N6FYJcc0/U7Uf3Cye1wI/AAAAAAAAAE8/EG46W1D_ea8/s1600/3.png)  
Here, lies() replaces the substring “*un6u4vy46*” with “*e*” in all places present in the 1st parameter to form “createWritableRaster”.
Even the random class and method names and the scattered code makes analyzing the code a challenge.
The execution of the .jar file is triggered from a compromised website.
The execution starts through the entry point “sash0k.start()” method with a long string parameter which it gets from the host site itself.
URL domains are extracted from this string and stored in an array.
Malware will connect to these domains and download actual malware executables after the machine has been successfully compromised.
Let’s look at each step in detail.
Initially, the code creates two BufferedImage objects in two different ways.
Let’s have a look on both.
**First object: “localBufferedImage1”**
Reflection(Java.lang.reflect) is used to invoke the setPixel() method present in the java.awt.image.CreateWritableRaster class using an object of BufferedImage subclass of the java.awt.image package.
An integer type object is then passed to set the Raster values.
The returned object is typecast to BufferedImage type and is stored as localBufferedImage1.
[![](/cdn-cgi/image/format=auto/sites/default/files/images/blogs/-kaBL8nGXwJo/U7UbrYQ6ROI/AAAAAAAAAEE/sxXy2O5vMOE/s1600/5.png)](/sites/default/files/images/blogs/-kaBL8nGXwJo/U7UbrYQ6ROI/AAAAAAAAAEE/sxXy2O5vMOE/s1600/5.png) 
**Second object: “localBufferedImage2”**
The second object is created by passing an object of the ComponentColorModel class to its parameterized constructor.[![](/cdn-cgi/image/format=auto/sites/default/files/images/blogs/-bjV6OIemT68/U7UcAUJRD3I/AAAAAAAAAEM/97POiAiwl1g/s1600/localBufferedImage2.png)](/sites/default/files/images/blogs/-bjV6OIemT68/U7UcAUJRD3I/AAAAAAAAAEM/97POiAiwl1g/s1600/localBufferedImage2.png) 
An important thing to note is that this ComponentColorModel object is created by passing an object of ICC\_ Colorspace constructed from an ICC\_Profile instance.
[![](/cdn-cgi/image/format=auto/sites/default/files/images/blogs/-EoZWpNbw3lg/U7UcUqsbx1I/AAAAAAAAAEU/IoJP4fyonYk/s1600/ComponentColorModel.png)](/sites/default/files/images/blogs/-EoZWpNbw3lg/U7UcUqsbx1I/AAAAAAAAAEU/IoJP4fyonYk/s1600/ComponentColorModel.png)
The SampleModel used in this case is the MultiPixelPackedSampleModel which has an interesting feature of writing the DataBuffer in the image.
To be clear, these two objects are different from each other.
Many image related classes are used in this code, but the only goal is to capture the flag!The actual exploitation occurs when the AffineTransformOp.filter() method is called with the two BufferedImage objects as parameters.
It is supposed to perform a linear mapping from 2D coordinates in the source Raster to 2D coordinates in the destination Raster.
[![](/cdn-cgi/image/format=auto/sites/default/files/images/blogs/-ADrQvzkb6Ao/U7Ue0BAADfI/AAAAAAAAAE0/yJWb_LhFllg/s1600/AffineTransformOp.png)](/sites/default/files/images/blogs/-ADrQvzkb6Ao/U7Ue0BAADfI/AAAAAAAAAE0/yJWb_LhFllg/s1600/AffineTransformOp.png)  
But before initiating the transformation, the ColorSpace compatibility is checked through the isCompatibleRaster() method of class “java.awt.image.ColorModel”.
This method becomes vulnerable because code bypasses this compatibility check to always return “True” by overriding it in a base class, which is Class “tiel3k” in our case.
The destination raster memory array is then overflown resulting in heap corruption.
[![](/cdn-cgi/image/format=auto/sites/default/files/images/blogs/-ykIt2uLaSds/U7Ucxoda7II/AAAAAAAAAEk/3q8X62ycyeg/s1600/isCompatible.png)](/sites/default/files/images/blogs/-ykIt2uLaSds/U7Ucxoda7II/AAAAAAAAAEk/3q8X62ycyeg/s1600/isCompatible.png) 
This vulnerability is thus named as the “Incorrect image channel verification” vulnerability.
Because the .jar runs as applet in user’s browser, the code must use SecurityManager and get required permissions to perform privileged actions like creating and executing files in memory in our case.
As we can guess, the destination of the overflow is in the heap region of localBufferedImage2 and the above access permissions are given only to this object.
Fields of volatile data types are created to allocate memory and write data in it.
If we go more deeper in the code, we see that 8192 bytes (8Kb) memory was reserved for localBufferedImage2 object (assuming a 4 byte Integer).
Now since the code has bypassed the Java sandbox protections of a browser, it’s ready to perform some privileged actions like file download and execution on the user machine.
The code ultimately connects to various URL domains, downloads .exe files, stores them in the *<temp>* folder and executes them.
[![](/cdn-cgi/image/format=auto/sites/default/files/images/blogs/-__CnPEiDSrc/U7Uc-qBQjtI/AAAAAAAAAEs/DjrnAyFbwJQ/s1600/codegd.png)](/sites/default/files/images/blogs/-__CnPEiDSrc/U7Uc-qBQjtI/AAAAAAAAAEs/DjrnAyFbwJQ/s1600/codegd.png) 
Since there has been no Java vulnerabilities reported as of yet in 2014, malware authors are using old exploits and rewriting the code with additional obfuscations.
Zscaler provides [JavaTest](/java_version.php)which is a free tool for checking the current java version.
The best way to stay safe is to regularly update to the current version of Java or to remove it altogether if it isn’t necessary to the machine in question.