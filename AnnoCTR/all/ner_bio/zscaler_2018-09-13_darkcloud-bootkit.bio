<DOCSTART>	O	O	O	O	O	O

DarkCloud	O	O	O	O	O	O
Bootkit	O	O	O	O	O	O

September	O	O	B-DATE	O	O	B-DATE
13	O	O	I-DATE	O	O	I-DATE
,	O	O	I-DATE	O	O	I-DATE
2018	O	O	I-DATE	O	O	I-DATE

In	O	O	O	O	O	O
an	O	O	O	O	O	O
earlier	O	O	O	O	O	O
[	O	O	O	O	O	O
blog	O	O	O	O	O	O
]	O	O	O	O	O	O
(	O	O	O	O	O	O
/	O	O	O	O	O	O
blogs	O	O	O	O	O	O
/	O	O	O	O	O	O
research	O	O	O	O	O	O
/	O	O	O	O	O	O
cryptominers-and-stealers-malware-edition	O	O	O	O	O	O
)	O	O	O	O	O	O
about	O	O	O	O	O	O
crypto-malware	O	O	O	O	O	O
,	O	O	O	O	O	O
we	O	O	O	O	O	O
described	O	O	O	O	O	O
different	O	O	O	O	O	O
techniques	O	O	O	O	O	O
used	O	O	O	O	O	O
by	O	O	O	O	O	O
cybercriminals	O	O	O	O	O	O
,	O	O	O	O	O	O
such	O	O	O	O	O	O
as	O	O	O	O	O	O
cryptomining	O	O	O	O	O	O
and	O	O	O	O	O	O
wallet	O	O	O	O	O	O
stealing	O	O	O	O	O	O
.	O	O	O	O	O	O

In	O	O	O	O	O	O
this	O	O	O	O	O	O
blog	O	O	O	O	O	O
,	O	O	O	O	O	O
we	O	O	O	O	O	O
will	O	O	O	O	O	O
provide	O	O	O	O	O	O
a	O	O	O	O	O	O
technical	O	O	O	O	O	O
analysis	O	O	O	O	O	O
of	O	O	O	O	O	O
yet	O	O	O	O	O	O
another	O	O	O	O	O	O
type	O	O	O	O	O	O
of	O	O	O	O	O	O
cryptominer	O	O	O	O	O	O
malware	O	O	O	O	O	O
using	O	O	O	O	O	O
a	O	O	O	O	O	O
bootkit	O	O	O	O	O	O
and	O	O	O	O	O	O
other	O	O	O	O	O	O
kernel-level	O	O	O	O	O	O
shellcode	O	O	O	O	O	O
for	O	O	O	O	O	O
persistence	O	O	O	O	O	O
.	O	O	O	O	O	O

*	O	O	O	O	O	O
*	O	O	O	O	O	O
Installation	O	O	O	O	O	O
*	O	O	O	O	O	O
*	O	O	O	O	O	O

The	O	O	O	O	O	O
installer	O	O	O	O	O	O
is	O	O	O	O	O	O
responsible	O	O	O	O	O	O
for	O	O	O	O	O	O
infecting	O	O	O	O	O	O
a	O	O	O	O	O	O
system	O	O	O	O	O	O
’	O	O	O	O	O	O
s	O	O	O	O	O	O
master	O	O	O	O	O	O
boot	O	O	O	O	O	O
record	O	O	O	O	O	O
(	O	O	O	O	O	O
MBR	O	O	O	O	O	O
)	O	O	O	O	O	O
,	O	O	O	O	O	O
which	O	O	O	O	O	O
identifies	O	O	O	O	O	O
how	O	O	O	O	O	O
and	O	O	O	O	O	O
where	O	O	O	O	O	O
the	O	O	O	O	O	O
operating	O	O	O	O	O	O
system	O	O	O	O	O	O
is	O	O	O	O	O	O
located	O	O	O	O	O	O
.	O	O	O	O	O	O

It	O	O	O	O	O	O
opens	O	O	O	O	O	O
the	O	O	O	O	O	O
boot	O	O	O	O	O	O
drive	O	O	O	O	O	O
(	O	O	O	O	O	O
figure	O	O	O	O	O	O
1	O	O	O	O	O	O
)	O	O	O	O	O	O
and	O	O	O	O	O	O
reads	O	O	O	O	O	O
the	O	O	O	O	O	O
first	O	O	O	O	O	O
0x400	O	O	O	O	O	O
bytes	O	O	O	O	O	O
,	O	O	O	O	O	O
which	O	O	O	O	O	O
is	O	O	O	O	O	O
MBR	O	O	O	O	O	O
data	O	O	O	O	O	O
.	O	O	O	O	O	O

!	O	O	O	O	O	O
[	O	O	O	O	O	O
]	O	O	O	O	O	O
(	O	O	O	O	O	O
/	O	O	O	O	O	O
cdn-cgi	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
/	O	O	O	O	O	O
format	O	O	O	O	O	O
=	O	O	O	O	O	O
auto	O	O	O	O	O	O
/	O	O	O	O	O	O
sites	O	O	O	O	O	O
/	O	O	O	O	O	O
default	O	O	O	O	O	O
/	O	O	O	O	O	O
files	O	O	O	O	O	O
/	O	O	O	O	O	O
images	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
_	O	O	O	O	O	O
1536858245	O	O	O	O	O	O
.	O	O	O	O	O	O
png	O	O	O	O	O	O
)	O	O	O	O	O	O

Figure	O	O	O	O	O	O
1	O	O	O	O	O	O
:	O	O	O	O	O	O
Opens	O	O	O	O	O	O
boot	O	O	O	O	O	O
drive	O	O	O	O	O	O

It	O	O	O	O	O	O
checks	O	O	O	O	O	O
for	O	O	O	O	O	O
GUID	O	O	O	O	O	O
Partition	O	O	O	O	O	O
Table	O	O	O	O	O	O
(	O	O	O	O	O	O
GPT	O	O	O	O	O	O
)	O	O	O	O	O	O
partition	O	O	O	O	O	O
flag	O	O	O	O	O	O
and	O	O	O	O	O	O
doesn	O	O	O	O	O	O
’	O	O	O	O	O	O
t	O	O	O	O	O	O
infect	O	O	O	O	O	O
GPT	O	O	O	O	O	O
disks	O	O	O	O	O	O
(	O	O	O	O	O	O
see	O	O	O	O	O	O
figure	O	O	O	O	O	O
2	O	O	O	O	O	O
)	O	O	O	O	O	O
.	O	O	O	O	O	O

!	O	O	O	O	O	O
[	O	O	O	O	O	O
]	O	O	O	O	O	O
(	O	O	O	O	O	O
/	O	O	O	O	O	O
cdn-cgi	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
/	O	O	O	O	O	O
format	O	O	O	O	O	O
=	O	O	O	O	O	O
auto	O	O	O	O	O	O
/	O	O	O	O	O	O
sites	O	O	O	O	O	O
/	O	O	O	O	O	O
default	O	O	O	O	O	O
/	O	O	O	O	O	O
files	O	O	O	O	O	O
/	O	O	O	O	O	O
images	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
_	O	O	O	O	O	O
1536859241	O	O	O	O	O	O
.	O	O	O	O	O	O
png	O	O	O	O	O	O
)	O	O	O	O	O	O

Figure	O	O	O	O	O	O
2	O	O	O	O	O	O
:	O	O	O	O	O	O
Checking	O	O	O	O	O	O
GPT	O	O	O	O	O	O
Disk	O	O	O	O	O	O

It	O	O	O	O	O	O
moves	O	O	O	O	O	O
the	O	O	O	O	O	O
clean	O	O	O	O	O	O
MBR	O	O	O	O	O	O
code	O	O	O	O	O	O
from	O	O	O	O	O	O
sector	O	O	O	O	O	O
0	O	O	O	O	O	O
to	O	O	O	O	O	O
sector	O	O	O	O	O	O
1	O	O	O	O	O	O
(	O	O	O	O	O	O
figure	O	O	O	O	O	O
3	O	O	O	O	O	O
)	O	O	O	O	O	O
and	O	O	O	O	O	O
inserts	O	O	O	O	O	O
malware	O	O	O	O	O	O
code	O	O	O	O	O	O
in	O	O	O	O	O	O
sector	O	O	O	O	O	O
0	O	O	O	O	O	O
(	O	O	O	O	O	O
figure	O	O	O	O	O	O
4	O	O	O	O	O	O
)	O	O	O	O	O	O
.	O	O	O	O	O	O

Malicious	O	O	O	O	O	O
code	O	O	O	O	O	O
is	O	O	O	O	O	O
written	O	O	O	O	O	O
from	O	O	O	O	O	O
sector	O	O	O	O	O	O
2	O	O	O	O	O	O
-	O	O	O	O	O	O
53	O	O	O	O	O	O
.	O	O	O	O	O	O

!	O	O	O	O	O	O
[	O	O	O	O	O	O
]	O	O	O	O	O	O
(	O	O	O	O	O	O
/	O	O	O	O	O	O
cdn-cgi	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
/	O	O	O	O	O	O
format	O	O	O	O	O	O
=	O	O	O	O	O	O
auto	O	O	O	O	O	O
/	O	O	O	O	O	O
sites	O	O	O	O	O	O
/	O	O	O	O	O	O
default	O	O	O	O	O	O
/	O	O	O	O	O	O
files	O	O	O	O	O	O
/	O	O	O	O	O	O
images	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
_	O	O	O	O	O	O
1536859305	O	O	O	O	O	O
.	O	O	O	O	O	O
png	O	O	O	O	O	O
)	O	O	O	O	O	O

Figure	O	O	O	O	O	O
3	O	O	O	O	O	O
:	O	O	O	O	O	O
Clean	O	O	O	O	O	O
MBR	O	O	O	O	O	O
code	O	O	O	O	O	O

!	O	O	O	O	O	O
[	O	O	O	O	O	O
]	O	O	O	O	O	O
(	O	O	O	O	O	O
/	O	O	O	O	O	O
cdn-cgi	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
/	O	O	O	O	O	O
format	O	O	O	O	O	O
=	O	O	O	O	O	O
auto	O	O	O	O	O	O
/	O	O	O	O	O	O
sites	O	O	O	O	O	O
/	O	O	O	O	O	O
default	O	O	O	O	O	O
/	O	O	O	O	O	O
files	O	O	O	O	O	O
/	O	O	O	O	O	O
images	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
_	O	O	O	O	O	O
1536859346	O	O	O	O	O	O
.	O	O	O	O	O	O
png	O	O	O	O	O	O
)	O	O	O	O	O	O

Figure	O	O	O	O	O	O
4	O	O	O	O	O	O
:	O	O	O	O	O	O
Infected	O	O	O	O	O	O
MBR	O	O	O	O	O	O
code	O	O	O	O	O	O

*	O	O	O	O	O	O
*	O	O	O	O	O	O
Analysis	O	O	O	O	O	O
for	O	O	O	O	O	O
malicious	O	O	O	O	O	O
MBR	O	O	O	O	O	O
*	O	O	O	O	O	O
*	O	O	O	O	O	O

Malicious	O	O	O	O	O	O
MBR	O	O	O	O	O	O
code	O	O	O	O	O	O
hooks	O	O	O	O	O	O
15h	O	O	O	O	O	O
interrupt	O	O	O	O	O	O
(	O	O	O	O	O	O
figure	O	O	O	O	O	O
5	O	O	O	O	O	O
)	O	O	O	O	O	O
.	O	O	O	O	O	O

It	O	O	O	O	O	O
specifically	O	O	O	O	O	O
hooks	O	O	O	O	O	O
for	O	O	O	O	O	O
service	O	O	O	O	O	O
0xE820	O	O	O	O	O	O
of	O	O	O	O	O	O
interrupt	O	O	O	O	O	O
(	O	O	O	O	O	O
int	O	O	O	O	O	O
)	O	O	O	O	O	O
15h	O	O	O	O	O	O
(	O	O	O	O	O	O
figure	O	O	O	O	O	O
6	O	O	O	O	O	O
)	O	O	O	O	O	O
.	O	O	O	O	O	O

This	O	O	O	O	O	O
service	O	O	O	O	O	O
is	O	O	O	O	O	O
used	O	O	O	O	O	O
to	O	O	O	O	O	O
query	O	O	O	O	O	O
system	O	O	O	O	O	O
memory	O	O	O	O	O	O
.	O	O	O	O	O	O

!	O	O	O	O	O	O
[	O	O	O	O	O	O
]	O	O	O	O	O	O
(	O	O	O	O	O	O
/	O	O	O	O	O	O
cdn-cgi	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
/	O	O	O	O	O	O
format	O	O	O	O	O	O
=	O	O	O	O	O	O
auto	O	O	O	O	O	O
/	O	O	O	O	O	O
sites	O	O	O	O	O	O
/	O	O	O	O	O	O
default	O	O	O	O	O	O
/	O	O	O	O	O	O
files	O	O	O	O	O	O
/	O	O	O	O	O	O
images	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
_	O	O	O	O	O	O
1536859425	O	O	O	O	O	O
.	O	O	O	O	O	O
png	O	O	O	O	O	O
)	O	O	O	O	O	O

Figure	O	O	O	O	O	O
5	O	O	O	O	O	O
:	O	O	O	O	O	O
Interrupt	O	O	O	O	O	O
15h	O	O	O	O	O	O
hooking	O	O	O	O	O	O

!	O	O	O	O	O	O
[	O	O	O	O	O	O
]	O	O	O	O	O	O
(	O	O	O	O	O	O
/	O	O	O	O	O	O
cdn-cgi	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
/	O	O	O	O	O	O
format	O	O	O	O	O	O
=	O	O	O	O	O	O
auto	O	O	O	O	O	O
/	O	O	O	O	O	O
sites	O	O	O	O	O	O
/	O	O	O	O	O	O
default	O	O	O	O	O	O
/	O	O	O	O	O	O
files	O	O	O	O	O	O
/	O	O	O	O	O	O
images	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
_	O	O	O	O	O	O
1536859469	O	O	O	O	O	O
.	O	O	O	O	O	O
png	O	O	O	O	O	O
)	O	O	O	O	O	O

Figure	O	O	O	O	O	O
6	O	O	O	O	O	O
:	O	O	O	O	O	O
Service	O	O	O	O	O	O
0xE820	O	O	O	O	O	O

After	O	O	O	O	O	O
hooking	O	O	O	O	O	O
,	O	O	O	O	O	O
it	O	O	O	O	O	O
loads	O	O	O	O	O	O
the	O	O	O	O	O	O
original	O	O	O	O	O	O
MBR	O	O	O	O	O	O
code	O	O	O	O	O	O
to	O	O	O	O	O	O
resume	O	O	O	O	O	O
the	O	O	O	O	O	O
booting	O	O	O	O	O	O
process	O	O	O	O	O	O
.	O	O	O	O	O	O

During	O	O	O	O	O	O
execution	O	O	O	O	O	O
,	O	O	O	O	O	O
when	O	O	O	O	O	O
bootloader	O	O	O	O	O	O
calls	O	O	O	O	O	O
int	O	O	O	O	O	O
15h	O	O	O	O	O	O
,	O	O	O	O	O	O
malware	O	O	O	O	O	O
code	O	O	O	O	O	O
receives	O	O	O	O	O	O
the	O	O	O	O	O	O
control	O	O	O	O	O	O
and	O	O	O	O	O	O
verifies	O	O	O	O	O	O
the	O	O	O	O	O	O
AddressRangeDescriptor	O	O	O	O	O	O
Type	O	O	O	O	O	O
,	O	O	O	O	O	O
BaseAddrLow	O	O	O	O	O	O
,	O	O	O	O	O	O
BaseAddrHigh	O	O	O	O	O	O
,	O	O	O	O	O	O
and	O	O	O	O	O	O
LengthLow	O	O	O	O	O	O
.	O	O	O	O	O	O

After	O	O	O	O	O	O
verification	O	O	O	O	O	O
,	O	O	O	O	O	O
it	O	O	O	O	O	O
modifies	O	O	O	O	O	O
the	O	O	O	O	O	O
LengthLow	O	O	O	O	O	O
value	O	O	O	O	O	O
to	O	O	O	O	O	O
hide	O	O	O	O	O	O
the	O	O	O	O	O	O
malicious	O	O	O	O	O	O
MBR	O	O	O	O	O	O
code	O	O	O	O	O	O
(	O	O	O	O	O	O
figure	O	O	O	O	O	O
7	O	O	O	O	O	O
)	O	O	O	O	O	O
.	O	O	O	O	O	O

!	O	O	O	O	O	O
[	O	O	O	O	O	O
]	O	O	O	O	O	O
(	O	O	O	O	O	O
/	O	O	O	O	O	O
cdn-cgi	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
/	O	O	O	O	O	O
format	O	O	O	O	O	O
=	O	O	O	O	O	O
auto	O	O	O	O	O	O
/	O	O	O	O	O	O
sites	O	O	O	O	O	O
/	O	O	O	O	O	O
default	O	O	O	O	O	O
/	O	O	O	O	O	O
files	O	O	O	O	O	O
/	O	O	O	O	O	O
images	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
_	O	O	O	O	O	O
1536859569	O	O	O	O	O	O
.	O	O	O	O	O	O
png	O	O	O	O	O	O
)	O	O	O	O	O	O

Figure	O	O	O	O	O	O
7	O	O	O	O	O	O
:	O	O	O	O	O	O
Hiding	O	O	O	O	O	O
malware	O	O	O	O	O	O
code	O	O	O	O	O	O

*	O	O	O	O	O	O
*	O	O	O	O	O	O
Loading	O	O	O	O	O	O
in	O	O	O	O	O	O
kernel	O	O	O	O	O	O
*	O	O	O	O	O	O
*	O	O	O	O	O	O

The	O	O	O	O	O	O
malware	O	O	O	O	O	O
uses	O	O	O	O	O	O
different	O	O	O	O	O	O
methods	O	O	O	O	O	O
,	O	O	O	O	O	O
depending	O	O	O	O	O	O
on	O	O	O	O	O	O
the	O	O	O	O	O	O
Windows	O	O	O	O	O	O
version	O	O	O	O	O	O
,	O	O	O	O	O	O
for	O	O	O	O	O	O
loading	O	O	O	O	O	O
into	O	O	O	O	O	O
the	O	O	O	O	O	O
kernel	O	O	O	O	O	O
.	O	O	O	O	O	O

Figure	O	O	O	O	O	O
8	O	O	O	O	O	O
lists	O	O	O	O	O	O
the	O	O	O	O	O	O
different	O	O	O	O	O	O
ways	O	O	O	O	O	O
for	O	O	O	O	O	O
XP	O	O	O	O	O	O
and	O	O	O	O	O	O
7	O	O	O	O	O	O
versions	O	O	O	O	O	O
of	O	O	O	O	O	O
Windows	O	O	O	O	O	O
.	O	O	O	O	O	O

!	O	O	O	O	O	O
[	O	O	O	O	O	O
]	O	O	O	O	O	O
(	O	O	O	O	O	O
/	O	O	O	O	O	O
cdn-cgi	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
/	O	O	O	O	O	O
format	O	O	O	O	O	O
=	O	O	O	O	O	O
auto	O	O	O	O	O	O
/	O	O	O	O	O	O
sites	O	O	O	O	O	O
/	O	O	O	O	O	O
default	O	O	O	O	O	O
/	O	O	O	O	O	O
files	O	O	O	O	O	O
/	O	O	O	O	O	O
images	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
_	O	O	O	O	O	O
1536859900	O	O	O	O	O	O
.	O	O	O	O	O	O
png	O	O	O	O	O	O
)	O	O	O	O	O	O

Figure	O	O	O	O	O	O
8	O	O	O	O	O	O
:	O	O	O	O	O	O
Flow	O	O	O	O	O	O
of	O	O	O	O	O	O
execution	O	O	O	O	O	O

In	O	O	O	O	O	O
Windows	O	O	O	O	O	O
XP	O	O	O	O	O	O
,	O	O	O	O	O	O
it	O	O	O	O	O	O
patches	O	O	O	O	O	O
code	O	O	O	O	O	O
in	O	O	O	O	O	O
BlLoadDeviceDriver	O	O	O	O	O	O
function	O	O	O	O	O	O
in	O	O	O	O	O	O
osloader.exe	O	O	O	O	O	O
.	O	O	O	O	O	O

It	O	O	O	O	O	O
also	O	O	O	O	O	O
patches	O	O	O	O	O	O
code	O	O	O	O	O	O
in	O	O	O	O	O	O
BlLoadDeviceDriver	O	O	O	O	O	O
after	O	O	O	O	O	O
it	O	O	O	O	O	O
calls	O	O	O	O	O	O
to	O	O	O	O	O	O
function	O	O	O	O	O	O
BlLoadImageEx	O	O	O	O	O	O
.	O	O	O	O	O	O

The	O	O	O	O	O	O
BlLoadImageEx	O	O	O	O	O	O
function	O	O	O	O	O	O
maps	O	O	O	O	O	O
all	O	O	O	O	O	O
device	O	O	O	O	O	O
drivers	O	O	O	O	O	O
in	O	O	O	O	O	O
memory	O	O	O	O	O	O
.	O	O	O	O	O	O

Ntoskrnl.exe	O	O	O	O	O	O
will	O	O	O	O	O	O
load	O	O	O	O	O	O
and	O	O	O	O	O	O
execute	O	O	O	O	O	O
these	O	O	O	O	O	O
drivers	O	O	O	O	O	O
(	O	O	O	O	O	O
IopInitializeBootDrivers	O	O	O	O	O	O
-	O	O	O	O	O	O
>	O	O	O	O	O	O
IopInitializeBuiltinDriver	O	O	O	O	O	O
)	O	O	O	O	O	O
(	O	O	O	O	O	O
figure	O	O	O	O	O	O
9	O	O	O	O	O	O
)	O	O	O	O	O	O
.	O	O	O	O	O	O

!	O	O	O	O	O	O
[	O	O	O	O	O	O
]	O	O	O	O	O	O
(	O	O	O	O	O	O
/	O	O	O	O	O	O
cdn-cgi	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
/	O	O	O	O	O	O
format	O	O	O	O	O	O
=	O	O	O	O	O	O
auto	O	O	O	O	O	O
/	O	O	O	O	O	O
sites	O	O	O	O	O	O
/	O	O	O	O	O	O
default	O	O	O	O	O	O
/	O	O	O	O	O	O
files	O	O	O	O	O	O
/	O	O	O	O	O	O
images	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
_	O	O	O	O	O	O
1536860151	O	O	O	O	O	O
.	O	O	O	O	O	O
png	O	O	O	O	O	O
)	O	O	O	O	O	O

!	O	O	O	O	O	O
[	O	O	O	O	O	O
]	O	O	O	O	O	O
(	O	O	O	O	O	O
/	O	O	O	O	O	O
cdn-cgi	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
/	O	O	O	O	O	O
format	O	O	O	O	O	O
=	O	O	O	O	O	O
auto	O	O	O	O	O	O
/	O	O	O	O	O	O
sites	O	O	O	O	O	O
/	O	O	O	O	O	O
default	O	O	O	O	O	O
/	O	O	O	O	O	O
files	O	O	O	O	O	O
/	O	O	O	O	O	O
images	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
_	O	O	O	O	O	O
1536860173	O	O	O	O	O	O
.	O	O	O	O	O	O
png	O	O	O	O	O	O
)	O	O	O	O	O	O

Figure	O	O	O	O	O	O
9	O	O	O	O	O	O
:	O	O	O	O	O	O
Comparison	O	O	O	O	O	O
of	O	O	O	O	O	O
patched	O	O	O	O	O	O
and	O	O	O	O	O	O
unpatched	O	O	O	O	O	O
code	O	O	O	O	O	O
of	O	O	O	O	O	O
BlLoadDeviceDriver	O	O	O	O	O	O
function	O	O	O	O	O	O

When	O	O	O	O	O	O
*	O	O	O	O	O	O
osloader.exe	O	O	O	O	O	O
*	O	O	O	O	O	O
tries	O	O	O	O	O	O
to	O	O	O	O	O	O
load	O	O	O	O	O	O
the	O	O	O	O	O	O
*	O	O	O	O	O	O
ftdisk.sys	O	O	O	O	O	O
*	O	O	O	O	O	O
driver	O	O	O	O	O	O
,	O	O	O	O	O	O
it	O	O	O	O	O	O
injects	O	O	O	O	O	O
malicious	O	O	O	O	O	O
shell	O	O	O	O	O	O
code	O	O	O	O	O	O
in	O	O	O	O	O	O
the	O	O	O	O	O	O
resource	O	O	O	O	O	O
section	O	O	O	O	O	O
and	O	O	O	O	O	O
a	O	O	O	O	O	O
modified	O	O	O	O	O	O
entry	O	O	O	O	O	O
point	O	O	O	O	O	O
to	O	O	O	O	O	O
malicious	O	O	O	O	O	O
shellcode	O	O	O	O	O	O
.	O	O	O	O	O	O

!	O	O	O	O	O	O
[	O	O	O	O	O	O
]	O	O	O	O	O	O
(	O	O	O	O	O	O
/	O	O	O	O	O	O
cdn-cgi	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
/	O	O	O	O	O	O
format	O	O	O	O	O	O
=	O	O	O	O	O	O
auto	O	O	O	O	O	O
/	O	O	O	O	O	O
sites	O	O	O	O	O	O
/	O	O	O	O	O	O
default	O	O	O	O	O	O
/	O	O	O	O	O	O
files	O	O	O	O	O	O
/	O	O	O	O	O	O
images	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
_	O	O	O	O	O	O
1536860272	O	O	O	O	O	O
.	O	O	O	O	O	O
png	O	O	O	O	O	O
)	O	O	O	O	O	O

Figure	O	O	O	O	O	O
10	O	O	O	O	O	O
:	O	O	O	O	O	O
Searching	O	O	O	O	O	O
for	O	O	O	O	O	O
resource	O	O	O	O	O	O
section	O	O	O	O	O	O
and	O	O	O	O	O	O
comparing	O	O	O	O	O	O
section	O	O	O	O	O	O
size	O	O	O	O	O	O
for	O	O	O	O	O	O
shellcode	O	O	O	O	O	O

!	O	O	O	O	O	O
[	O	O	O	O	O	O
]	O	O	O	O	O	O
(	O	O	O	O	O	O
/	O	O	O	O	O	O
cdn-cgi	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
/	O	O	O	O	O	O
format	O	O	O	O	O	O
=	O	O	O	O	O	O
auto	O	O	O	O	O	O
/	O	O	O	O	O	O
sites	O	O	O	O	O	O
/	O	O	O	O	O	O
default	O	O	O	O	O	O
/	O	O	O	O	O	O
files	O	O	O	O	O	O
/	O	O	O	O	O	O
images	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
_	O	O	O	O	O	O
1536860305	O	O	O	O	O	O
.	O	O	O	O	O	O
png	O	O	O	O	O	O
)	O	O	O	O	O	O

Figure	O	O	O	O	O	O
11	O	O	O	O	O	O
:	O	O	O	O	O	O
Malware	O	O	O	O	O	O
shellcode	O	O	O	O	O	O
in	O	O	O	O	O	O
the	O	O	O	O	O	O
*	O	O	O	O	O	O
ftdisk.sys	O	O	O	O	O	O
*	O	O	O	O	O	O
resource	O	O	O	O	O	O
section	O	O	O	O	O	O

In	O	O	O	O	O	O
Windows	O	O	O	O	O	O
7	O	O	O	O	O	O
,	O	O	O	O	O	O
the	O	O	O	O	O	O
malware	O	O	O	O	O	O
searches	O	O	O	O	O	O
the	O	O	O	O	O	O
address	O	O	O	O	O	O
of	O	O	O	O	O	O
the	O	O	O	O	O	O
OslArchTransferToKernel	O	O	O	O	O	O
function	O	O	O	O	O	O
from	O	O	O	O	O	O
OslpMain	O	O	O	O	O	O
(	O	O	O	O	O	O
entry	O	O	O	O	O	O
point	O	O	O	O	O	O
)	O	O	O	O	O	O
in	O	O	O	O	O	O
*	O	O	O	O	O	O
winload.exe	O	O	O	O	O	O
*	O	O	O	O	O	O
.	O	O	O	O	O	O

OslArchTransferToKernel	O	O	O	O	O	O
transfers	O	O	O	O	O	O
control	O	O	O	O	O	O
to	O	O	O	O	O	O
NTOSKRNL.EXE	O	O	O	O	O	O
.	O	O	O	O	O	O

The	O	O	O	O	O	O
malware	O	O	O	O	O	O
patches	O	O	O	O	O	O
this	O	O	O	O	O	O
function	O	O	O	O	O	O
(	O	O	O	O	O	O
figure	O	O	O	O	O	O
12	O	O	O	O	O	O
)	O	O	O	O	O	O
to	O	O	O	O	O	O
get	O	O	O	O	O	O
the	O	O	O	O	O	O
loading	O	O	O	O	O	O
address	O	O	O	O	O	O
of	O	O	O	O	O	O
NTOSKRNL.EXE	O	O	O	O	O	O
.	O	O	O	O	O	O

!	O	O	O	O	O	O
[	O	O	O	O	O	O
]	O	O	O	O	O	O
(	O	O	O	O	O	O
/	O	O	O	O	O	O
cdn-cgi	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
/	O	O	O	O	O	O
format	O	O	O	O	O	O
=	O	O	O	O	O	O
auto	O	O	O	O	O	O
/	O	O	O	O	O	O
sites	O	O	O	O	O	O
/	O	O	O	O	O	O
default	O	O	O	O	O	O
/	O	O	O	O	O	O
files	O	O	O	O	O	O
/	O	O	O	O	O	O
images	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
_	O	O	O	O	O	O
1536860350	O	O	O	O	O	O
.	O	O	O	O	O	O
png	O	O	O	O	O	O
)	O	O	O	O	O	O

Figure	O	O	O	O	O	O
12	O	O	O	O	O	O
:	O	O	O	O	O	O
Patched	O	O	O	O	O	O
OslArchTransferToKernel	O	O	O	O	O	O
function	O	O	O	O	O	O
code	O	O	O	O	O	O

After	O	O	O	O	O	O
getting	O	O	O	O	O	O
control	O	O	O	O	O	O
to	O	O	O	O	O	O
*	O	O	O	O	O	O
NTOSKRNL.EXE	O	O	O	O	O	O
*	O	O	O	O	O	O
,	O	O	O	O	O	O
the	O	O	O	O	O	O
malware	O	O	O	O	O	O
patches	O	O	O	O	O	O
ZwCreateSection	O	O	O	O	O	O
API	O	O	O	O	O	O
(	O	O	O	O	O	O
figure	O	O	O	O	O	O
13	O	O	O	O	O	O
)	O	O	O	O	O	O
.	O	O	O	O	O	O

!	O	O	O	O	O	O
[	O	O	O	O	O	O
]	O	O	O	O	O	O
(	O	O	O	O	O	O
/	O	O	O	O	O	O
cdn-cgi	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
/	O	O	O	O	O	O
format	O	O	O	O	O	O
=	O	O	O	O	O	O
auto	O	O	O	O	O	O
/	O	O	O	O	O	O
sites	O	O	O	O	O	O
/	O	O	O	O	O	O
default	O	O	O	O	O	O
/	O	O	O	O	O	O
files	O	O	O	O	O	O
/	O	O	O	O	O	O
images	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
_	O	O	O	O	O	O
1536860397	O	O	O	O	O	O
.	O	O	O	O	O	O
png	O	O	O	O	O	O
)	O	O	O	O	O	O

Figure	O	O	O	O	O	O
13	O	O	O	O	O	O
:	O	O	O	O	O	O
Patched	O	O	O	O	O	O
ZwCreateSection	O	O	O	O	O	O
API	O	O	O	O	O	O

*	O	O	O	O	O	O
*	O	O	O	O	O	O
Analysis	O	O	O	O	O	O
of	O	O	O	O	O	O
kernel	O	O	O	O	O	O
shellcode1	O	O	O	O	O	O
:	O	O	O	O	O	O
*	O	O	O	O	O	O
*	O	O	O	O	O	O

This	O	O	O	O	O	O
shellcode	O	O	O	O	O	O
is	O	O	O	O	O	O
responsible	O	O	O	O	O	O
for	O	O	O	O	O	O
hiding	O	O	O	O	O	O
the	O	O	O	O	O	O
malicious	O	O	O	O	O	O
MBR	O	O	O	O	O	O
code	O	O	O	O	O	O
and	O	O	O	O	O	O
preventing	O	O	O	O	O	O
AV	O	O	O	O	O	O
products	O	O	O	O	O	O
from	O	O	O	O	O	O
loading	O	O	O	O	O	O
.	O	O	O	O	O	O

Shellcode	O	O	O	O	O	O
first	O	O	O	O	O	O
retrieves	O	O	O	O	O	O
the	O	O	O	O	O	O
base	O	O	O	O	O	O
address	O	O	O	O	O	O
of	O	O	O	O	O	O
ntoskrnl.exe	O	O	O	O	O	O
and	O	O	O	O	O	O
gets	O	O	O	O	O	O
the	O	O	O	O	O	O
address	O	O	O	O	O	O
of	O	O	O	O	O	O
different	O	O	O	O	O	O
APIs	O	O	O	O	O	O
.	O	O	O	O	O	O

An	O	O	O	O	O	O
undocumented	O	O	O	O	O	O
field	O	O	O	O	O	O
(	O	O	O	O	O	O
at	O	O	O	O	O	O
offset	O	O	O	O	O	O
0x14	O	O	O	O	O	O
)	O	O	O	O	O	O
of	O	O	O	O	O	O
DRIVE	O	O	O	O	O	O
\	O	O	O	O	O	O
_	O	O	O	O	O	O
OBJECT	O	O	O	O	O	O
is	O	O	O	O	O	O
used	O	O	O	O	O	O
to	O	O	O	O	O	O
retrieve	O	O	O	O	O	O
the	O	O	O	O	O	O
 	O	O	O	O	O	O
MODULE	O	O	O	O	O	O
\	O	O	O	O	O	O
_	O	O	O	O	O	O
ENTRY	O	O	O	O	O	O
pointer	O	O	O	O	O	O
and	O	O	O	O	O	O
enumerated	O	O	O	O	O	O
to	O	O	O	O	O	O
get	O	O	O	O	O	O
base	O	O	O	O	O	O
address	O	O	O	O	O	O
of	O	O	O	O	O	O
*	O	O	O	O	O	O
ntoskrnl.exe	O	O	O	O	O	O
*	O	O	O	O	O	O
(	O	O	O	O	O	O
see	O	O	O	O	O	O
figure14	O	O	O	O	O	O
)	O	O	O	O	O	O
.	O	O	O	O	O	O

!	O	O	O	O	O	O
[	O	O	O	O	O	O
]	O	O	O	O	O	O
(	O	O	O	O	O	O
/	O	O	O	O	O	O
cdn-cgi	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
/	O	O	O	O	O	O
format	O	O	O	O	O	O
=	O	O	O	O	O	O
auto	O	O	O	O	O	O
/	O	O	O	O	O	O
sites	O	O	O	O	O	O
/	O	O	O	O	O	O
default	O	O	O	O	O	O
/	O	O	O	O	O	O
files	O	O	O	O	O	O
/	O	O	O	O	O	O
images	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
_	O	O	O	O	O	O
1536860432	O	O	O	O	O	O
.	O	O	O	O	O	O
png	O	O	O	O	O	O
)	O	O	O	O	O	O

Figure	O	O	O	O	O	O
14	O	O	O	O	O	O
:	O	O	O	O	O	O
Searching	O	O	O	O	O	O
for	O	O	O	O	O	O
base	O	O	O	O	O	O
address	O	O	O	O	O	O
of	O	O	O	O	O	O
*	O	O	O	O	O	O
ntoskrnl.exe	O	O	O	O	O	O
*	O	O	O	O	O	O

API	O	O	O	O	O	O
names	O	O	O	O	O	O
are	O	O	O	O	O	O
stored	O	O	O	O	O	O
as	O	O	O	O	O	O
32	O	O	O	O	O	O
-	O	O	O	O	O	O
bit	O	O	O	O	O	O
hash	O	O	O	O	O	O
values	O	O	O	O	O	O
in	O	O	O	O	O	O
the	O	O	O	O	O	O
code	O	O	O	O	O	O
.	O	O	O	O	O	O

The	O	O	O	O	O	O
ROR13	O	O	O	O	O	O
calculation	O	O	O	O	O	O
method	O	O	O	O	O	O
is	O	O	O	O	O	O
used	O	O	O	O	O	O
to	O	O	O	O	O	O
generate	O	O	O	O	O	O
hash	O	O	O	O	O	O
values	O	O	O	O	O	O
for	O	O	O	O	O	O
each	O	O	O	O	O	O
API	O	O	O	O	O	O
name	O	O	O	O	O	O
(	O	O	O	O	O	O
figure	O	O	O	O	O	O
15	O	O	O	O	O	O
)	O	O	O	O	O	O
.	O	O	O	O	O	O

!	O	O	O	O	O	O
[	O	O	O	O	O	O
]	O	O	O	O	O	O
(	O	O	O	O	O	O
/	O	O	O	O	O	O
cdn-cgi	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
/	O	O	O	O	O	O
format	O	O	O	O	O	O
=	O	O	O	O	O	O
auto	O	O	O	O	O	O
/	O	O	O	O	O	O
sites	O	O	O	O	O	O
/	O	O	O	O	O	O
default	O	O	O	O	O	O
/	O	O	O	O	O	O
files	O	O	O	O	O	O
/	O	O	O	O	O	O
images	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
_	O	O	O	O	O	O
1536860475	O	O	O	O	O	O
.	O	O	O	O	O	O
png	O	O	O	O	O	O
)	O	O	O	O	O	O

Figure	O	O	O	O	O	O
15	O	O	O	O	O	O
:	O	O	O	O	O	O
API	O	O	O	O	O	O
hash	O	O	O	O	O	O
calculation	O	O	O	O	O	O

*	O	O	O	O	O	O
*	O	O	O	O	O	O
AntiAV	O	O	O	O	O	O
techniques	O	O	O	O	O	O
*	O	O	O	O	O	O
*	O	O	O	O	O	O

To	O	O	O	O	O	O
stop	O	O	O	O	O	O
AV	O	O	O	O	O	O
systems	O	O	O	O	O	O
from	O	O	O	O	O	O
loading	O	O	O	O	O	O
,	O	O	O	O	O	O
the	O	O	O	O	O	O
malware	O	O	O	O	O	O
creates	O	O	O	O	O	O
notification	O	O	O	O	O	O
objects	O	O	O	O	O	O
similar	O	O	O	O	O	O
to	O	O	O	O	O	O
the	O	O	O	O	O	O
device	O	O	O	O	O	O
names	O	O	O	O	O	O
used	O	O	O	O	O	O
in	O	O	O	O	O	O
360	O	O	O	O	O	O
AV	O	O	O	O	O	O
product	O	O	O	O	O	O
device	O	O	O	O	O	O
drivers	O	O	O	O	O	O
.	O	O	O	O	O	O

!	O	O	O	O	O	O
[	O	O	O	O	O	O
]	O	O	O	O	O	O
(	O	O	O	O	O	O
/	O	O	O	O	O	O
cdn-cgi	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
/	O	O	O	O	O	O
format	O	O	O	O	O	O
=	O	O	O	O	O	O
auto	O	O	O	O	O	O
/	O	O	O	O	O	O
sites	O	O	O	O	O	O
/	O	O	O	O	O	O
default	O	O	O	O	O	O
/	O	O	O	O	O	O
files	O	O	O	O	O	O
/	O	O	O	O	O	O
images	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
_	O	O	O	O	O	O
1536860517	O	O	O	O	O	O
.	O	O	O	O	O	O
png	O	O	O	O	O	O
)	O	O	O	O	O	O

Figure	O	O	O	O	O	O
16	O	O	O	O	O	O
:	O	O	O	O	O	O
Holding	O	O	O	O	O	O
AV-related	O	O	O	O	O	O
device	O	O	O	O	O	O
names	O	O	O	O	O	O

*	O	O	O	O	O	O
*	O	O	O	O	O	O
Hiding	O	O	O	O	O	O
Malicious	O	O	O	O	O	O
MBR	O	O	O	O	O	O
code	O	O	O	O	O	O
*	O	O	O	O	O	O
*	O	O	O	O	O	O

Different	O	O	O	O	O	O
low-level	O	O	O	O	O	O
drivers	O	O	O	O	O	O
are	O	O	O	O	O	O
patched	O	O	O	O	O	O
to	O	O	O	O	O	O
hide	O	O	O	O	O	O
malicious	O	O	O	O	O	O
MBR	O	O	O	O	O	O
code	O	O	O	O	O	O
.	O	O	O	O	O	O

In	O	O	O	O	O	O
Windows	O	O	O	O	O	O
XP	O	O	O	O	O	O
,	O	O	O	O	O	O
the	O	O	O	O	O	O
IdePortStartIo	O	O	O	O	O	O
function	O	O	O	O	O	O
of	O	O	O	O	O	O
atapi.sys	O	O	O	O	O	O
is	O	O	O	O	O	O
hooked	O	O	O	O	O	O
(	O	O	O	O	O	O
figure	O	O	O	O	O	O
17	O	O	O	O	O	O
)	O	O	O	O	O	O
.	O	O	O	O	O	O

!	O	O	O	O	O	O
[	O	O	O	O	O	O
]	O	O	O	O	O	O
(	O	O	O	O	O	O
/	O	O	O	O	O	O
cdn-cgi	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
/	O	O	O	O	O	O
format	O	O	O	O	O	O
=	O	O	O	O	O	O
auto	O	O	O	O	O	O
/	O	O	O	O	O	O
sites	O	O	O	O	O	O
/	O	O	O	O	O	O
default	O	O	O	O	O	O
/	O	O	O	O	O	O
files	O	O	O	O	O	O
/	O	O	O	O	O	O
images	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
_	O	O	O	O	O	O
1536860566	O	O	O	O	O	O
.	O	O	O	O	O	O
png	O	O	O	O	O	O
)	O	O	O	O	O	O

Figure	O	O	O	O	O	O
17	O	O	O	O	O	O
:	O	O	O	O	O	O
Hooking	O	O	O	O	O	O
IdePortStartIo	O	O	O	O	O	O
function	O	O	O	O	O	O
of	O	O	O	O	O	O
atapi.sys	O	O	O	O	O	O

The	O	O	O	O	O	O
hooking	O	O	O	O	O	O
function	O	O	O	O	O	O
specifically	O	O	O	O	O	O
looks	O	O	O	O	O	O
for	O	O	O	O	O	O
read	O	O	O	O	O	O
and	O	O	O	O	O	O
write	O	O	O	O	O	O
requests	O	O	O	O	O	O
(	O	O	O	O	O	O
figure	O	O	O	O	O	O
18	O	O	O	O	O	O
)	O	O	O	O	O	O
.	O	O	O	O	O	O

If	O	O	O	O	O	O
there	O	O	O	O	O	O
is	O	O	O	O	O	O
a	O	O	O	O	O	O
read	O	O	O	O	O	O
request	O	O	O	O	O	O
for	O	O	O	O	O	O
sector	O	O	O	O	O	O
0	O	O	O	O	O	O
-	O	O	O	O	O	O
61	O	O	O	O	O	O
,	O	O	O	O	O	O
it	O	O	O	O	O	O
hooks	O	O	O	O	O	O
CompletionRoutine	O	O	O	O	O	O
of	O	O	O	O	O	O
IRP	O	O	O	O	O	O
sent	O	O	O	O	O	O
to	O	O	O	O	O	O
atapiDeviceObject	O	O	O	O	O	O
and	O	O	O	O	O	O
serves	O	O	O	O	O	O
a	O	O	O	O	O	O
clean	O	O	O	O	O	O
MBR	O	O	O	O	O	O
code	O	O	O	O	O	O
.	O	O	O	O	O	O

!	O	O	O	O	O	O
[	O	O	O	O	O	O
]	O	O	O	O	O	O
(	O	O	O	O	O	O
/	O	O	O	O	O	O
cdn-cgi	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
/	O	O	O	O	O	O
format	O	O	O	O	O	O
=	O	O	O	O	O	O
auto	O	O	O	O	O	O
/	O	O	O	O	O	O
sites	O	O	O	O	O	O
/	O	O	O	O	O	O
default	O	O	O	O	O	O
/	O	O	O	O	O	O
files	O	O	O	O	O	O
/	O	O	O	O	O	O
images	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
_	O	O	O	O	O	O
1536860612	O	O	O	O	O	O
.	O	O	O	O	O	O
png	O	O	O	O	O	O
)	O	O	O	O	O	O

Figure	O	O	O	O	O	O
18	O	O	O	O	O	O
:	O	O	O	O	O	O
Checking	O	O	O	O	O	O
SCSI	O	O	O	O	O	O
command	O	O	O	O	O	O
descriptor	O	O	O	O	O	O
block	O	O	O	O	O	O
(	O	O	O	O	O	O
CDB	O	O	O	O	O	O
)	O	O	O	O	O	O
for	O	O	O	O	O	O
read	O	O	O	O	O	O
and	O	O	O	O	O	O
write	O	O	O	O	O	O
request	O	O	O	O	O	O

If	O	O	O	O	O	O
there	O	O	O	O	O	O
is	O	O	O	O	O	O
a	O	O	O	O	O	O
write	O	O	O	O	O	O
request	O	O	O	O	O	O
for	O	O	O	O	O	O
sector	O	O	O	O	O	O
0	O	O	O	O	O	O
-	O	O	O	O	O	O
61	O	O	O	O	O	O
,	O	O	O	O	O	O
the	O	O	O	O	O	O
malware	O	O	O	O	O	O
modifies	O	O	O	O	O	O
the	O	O	O	O	O	O
operation	O	O	O	O	O	O
code	O	O	O	O	O	O
in	O	O	O	O	O	O
command	O	O	O	O	O	O
descriptor	O	O	O	O	O	O
block	O	O	O	O	O	O
(	O	O	O	O	O	O
CDB	O	O	O	O	O	O
)	O	O	O	O	O	O
and	O	O	O	O	O	O
SrbFlags	O	O	O	O	O	O
flags	O	O	O	O	O	O
of	O	O	O	O	O	O
SCSI	O	O	O	O	O	O
\	O	O	O	O	O	O
_	O	O	O	O	O	O
REQUEST	O	O	O	O	O	O
\	O	O	O	O	O	O
_	O	O	O	O	O	O
BLOCK	O	O	O	O	O	O
object	O	O	O	O	O	O
.	O	O	O	O	O	O

The	O	O	O	O	O	O
operation	O	O	O	O	O	O
code	O	O	O	O	O	O
is	O	O	O	O	O	O
changed	O	O	O	O	O	O
to	O	O	O	O	O	O
0x28	O	O	O	O	O	O
(	O	O	O	O	O	O
SCSIOP	O	O	O	O	O	O
\	O	O	O	O	O	O
_	O	O	O	O	O	O
READ	O	O	O	O	O	O
)	O	O	O	O	O	O
and	O	O	O	O	O	O
the	O	O	O	O	O	O
SrbFlags	O	O	O	O	O	O
are	O	O	O	O	O	O
set	O	O	O	O	O	O
to	O	O	O	O	O	O
SRB	O	O	O	O	O	O
\	O	O	O	O	O	O
_	O	O	O	O	O	O
FLAGS	O	O	O	O	O	O
\	O	O	O	O	O	O
_	O	O	O	O	O	O
DATA	O	O	O	O	O	O
\	O	O	O	O	O	O
_	O	O	O	O	O	O
IN	O	O	O	O	O	O
which	O	O	O	O	O	O
indicates	O	O	O	O	O	O
that	O	O	O	O	O	O
it	O	O	O	O	O	O
is	O	O	O	O	O	O
a	O	O	O	O	O	O
read	O	O	O	O	O	O
operation	O	O	O	O	O	O
.	O	O	O	O	O	O

So	O	O	O	O	O	O
,	O	O	O	O	O	O
the	O	O	O	O	O	O
write	O	O	O	O	O	O
request	O	O	O	O	O	O
is	O	O	O	O	O	O
simply	O	O	O	O	O	O
converted	O	O	O	O	O	O
to	O	O	O	O	O	O
a	O	O	O	O	O	O
read	O	O	O	O	O	O
request	O	O	O	O	O	O
and	O	O	O	O	O	O
passed	O	O	O	O	O	O
to	O	O	O	O	O	O
the	O	O	O	O	O	O
driver	O	O	O	O	O	O
.	O	O	O	O	O	O

Figure	O	O	O	O	O	O
19	O	O	O	O	O	O
shows	O	O	O	O	O	O
the	O	O	O	O	O	O
execution	O	O	O	O	O	O
flow	O	O	O	O	O	O
of	O	O	O	O	O	O
the	O	O	O	O	O	O
MBR	O	O	O	O	O	O
hiding	O	O	O	O	O	O
function	O	O	O	O	O	O
.	O	O	O	O	O	O

!	O	O	O	O	O	O
[	O	O	O	O	O	O
]	O	O	O	O	O	O
(	O	O	O	O	O	O
/	O	O	O	O	O	O
cdn-cgi	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
/	O	O	O	O	O	O
format	O	O	O	O	O	O
=	O	O	O	O	O	O
auto	O	O	O	O	O	O
/	O	O	O	O	O	O
sites	O	O	O	O	O	O
/	O	O	O	O	O	O
default	O	O	O	O	O	O
/	O	O	O	O	O	O
files	O	O	O	O	O	O
/	O	O	O	O	O	O
images	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
_	O	O	O	O	O	O
1536860653	O	O	O	O	O	O
.	O	O	O	O	O	O
png	O	O	O	O	O	O
)	O	O	O	O	O	O

Figure	O	O	O	O	O	O
19	O	O	O	O	O	O
:	O	O	O	O	O	O
IdePortStartIo	O	O	O	O	O	O
hook	O	O	O	O	O	O
function	O	O	O	O	O	O
execution	O	O	O	O	O	O
flow	O	O	O	O	O	O

*	O	O	O	O	O	O
*	O	O	O	O	O	O
Analysis	O	O	O	O	O	O
of	O	O	O	O	O	O
kernel	O	O	O	O	O	O
shellcode	O	O	O	O	O	O
2	O	O	O	O	O	O
:	O	O	O	O	O	O
*	O	O	O	O	O	O
*	O	O	O	O	O	O

This	O	O	O	O	O	O
shellcode	O	O	O	O	O	O
executes	O	O	O	O	O	O
as	O	O	O	O	O	O
a	O	O	O	O	O	O
system	O	O	O	O	O	O
thread	O	O	O	O	O	O
but	O	O	O	O	O	O
terminates	O	O	O	O	O	O
itself	O	O	O	O	O	O
if	O	O	O	O	O	O
the	O	O	O	O	O	O
system	O	O	O	O	O	O
is	O	O	O	O	O	O
booting	O	O	O	O	O	O
in	O	O	O	O	O	O
safe	O	O	O	O	O	O
mode	O	O	O	O	O	O
.	O	O	O	O	O	O

It	O	O	O	O	O	O
searches	O	O	O	O	O	O
for	O	O	O	O	O	O
the	O	O	O	O	O	O
explorer.exe	O	O	O	O	O	O
process	O	O	O	O	O	O
and	O	O	O	O	O	O
injects	O	O	O	O	O	O
usermode	O	O	O	O	O	O
shellcode	O	O	O	O	O	O
(	O	O	O	O	O	O
referred	O	O	O	O	O	O
as	O	O	O	O	O	O
ushellcode1	O	O	O	O	O	O
afterword	O	O	O	O	O	O
)	O	O	O	O	O	O
.	O	O	O	O	O	O

Ushellcode1	O	O	O	O	O	O
is	O	O	O	O	O	O
compressed	O	O	O	O	O	O
using	O	O	O	O	O	O
LZ	O	O	O	O	O	O
compression	O	O	O	O	O	O
with	O	O	O	O	O	O
COMPRESSION	O	O	O	O	O	O
\	O	O	O	O	O	O
_	O	O	O	O	O	O
ENGINE	O	O	O	O	O	O
\	O	O	O	O	O	O
_	O	O	O	O	O	O
MAXIMUM	O	O	O	O	O	O
flag	O	O	O	O	O	O
(	O	O	O	O	O	O
figure	O	O	O	O	O	O
20	O	O	O	O	O	O
)	O	O	O	O	O	O
.	O	O	O	O	O	O

!	O	O	O	O	O	O
[	O	O	O	O	O	O
]	O	O	O	O	O	O
(	O	O	O	O	O	O
/	O	O	O	O	O	O
cdn-cgi	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
/	O	O	O	O	O	O
format	O	O	O	O	O	O
=	O	O	O	O	O	O
auto	O	O	O	O	O	O
/	O	O	O	O	O	O
sites	O	O	O	O	O	O
/	O	O	O	O	O	O
default	O	O	O	O	O	O
/	O	O	O	O	O	O
files	O	O	O	O	O	O
/	O	O	O	O	O	O
images	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
_	O	O	O	O	O	O
1536860699	O	O	O	O	O	O
.	O	O	O	O	O	O
png	O	O	O	O	O	O
)	O	O	O	O	O	O

Figure	O	O	O	O	O	O
20	O	O	O	O	O	O
:	O	O	O	O	O	O
First	O	O	O	O	O	O
usermode	O	O	O	O	O	O
shellcode	O	O	O	O	O	O

Ushellcode1	O	O	O	O	O	O
is	O	O	O	O	O	O
injected	O	O	O	O	O	O
in	O	O	O	O	O	O
explorer.exe	O	O	O	O	O	O
with	O	O	O	O	O	O
thread	O	O	O	O	O	O
data	O	O	O	O	O	O
,	O	O	O	O	O	O
which	O	O	O	O	O	O
is	O	O	O	O	O	O
shared	O	O	O	O	O	O
memory	O	O	O	O	O	O
between	O	O	O	O	O	O
the	O	O	O	O	O	O
kernel	O	O	O	O	O	O
mode	O	O	O	O	O	O
thread	O	O	O	O	O	O
and	O	O	O	O	O	O
ushellcode1	O	O	O	O	O	O
thread	O	O	O	O	O	O
,	O	O	O	O	O	O
as	O	O	O	O	O	O
shown	O	O	O	O	O	O
in	O	O	O	O	O	O
figure	O	O	O	O	O	O
21	O	O	O	O	O	O
.	O	O	O	O	O	O

The	O	O	O	O	O	O
remote	O	O	O	O	O	O
APC	O	O	O	O	O	O
thread	O	O	O	O	O	O
technique	O	O	O	O	O	O
,	O	O	O	O	O	O
KeInitializeApc	O	O	O	O	O	O
,	O	O	O	O	O	O
and	O	O	O	O	O	O
KeInsertQueueApc	O	O	O	O	O	O
kernel	O	O	O	O	O	O
APIs	O	O	O	O	O	O
are	O	O	O	O	O	O
used	O	O	O	O	O	O
to	O	O	O	O	O	O
achieve	O	O	O	O	O	O
this	O	O	O	O	O	O
.	O	O	O	O	O	O

It	O	O	O	O	O	O
also	O	O	O	O	O	O
executes	O	O	O	O	O	O
downloaded	O	O	O	O	O	O
kernel	O	O	O	O	O	O
shellcode	O	O	O	O	O	O
by	O	O	O	O	O	O
the	O	O	O	O	O	O
ushellcode1	O	O	O	O	O	O
.	O	O	O	O	O	O

!	O	O	O	O	O	O
[	O	O	O	O	O	O
]	O	O	O	O	O	O
(	O	O	O	O	O	O
/	O	O	O	O	O	O
cdn-cgi	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
/	O	O	O	O	O	O
format	O	O	O	O	O	O
=	O	O	O	O	O	O
auto	O	O	O	O	O	O
/	O	O	O	O	O	O
sites	O	O	O	O	O	O
/	O	O	O	O	O	O
default	O	O	O	O	O	O
/	O	O	O	O	O	O
files	O	O	O	O	O	O
/	O	O	O	O	O	O
images	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
_	O	O	O	O	O	O
1536860743	O	O	O	O	O	O
.	O	O	O	O	O	O
png	O	O	O	O	O	O
)	O	O	O	O	O	O

Figure	O	O	O	O	O	O
21	O	O	O	O	O	O
:	O	O	O	O	O	O
Thread	O	O	O	O	O	O
data	O	O	O	O	O	O

In	O	O	O	O	O	O
the	O	O	O	O	O	O
second	O	O	O	O	O	O
step	O	O	O	O	O	O
,	O	O	O	O	O	O
it	O	O	O	O	O	O
searches	O	O	O	O	O	O
for	O	O	O	O	O	O
processes	O	O	O	O	O	O
related	O	O	O	O	O	O
to	O	O	O	O	O	O
different	O	O	O	O	O	O
security	O	O	O	O	O	O
software	O	O	O	O	O	O
solutions	O	O	O	O	O	O
(	O	O	O	O	O	O
table	O	O	O	O	O	O
1	O	O	O	O	O	O
)	O	O	O	O	O	O
and	O	O	O	O	O	O
terminates	O	O	O	O	O	O
the	O	O	O	O	O	O
process	O	O	O	O	O	O
.	O	O	O	O	O	O

|	O	O	O	O	O	O
*	O	O	O	O	O	O
*	O	O	O	O	O	O
Process	O	O	O	O	O	O
Names	O	O	O	O	O	O
*	O	O	O	O	O	O
*	O	O	O	O	O	O
|	O	O	O	O	O	O

|	O	O	O	O	O	O
avp.exe	O	O	O	O	O	O
|	O	O	O	O	O	O
ekrn.exe	O	O	O	O	O	O
|	O	O	O	O	O	O
safedogguardcenter.exe	O	O	O	O	O	O
|	O	O	O	O	O	O

|	O	O	O	O	O	O
zhudongfangyu.exe	O	O	O	O	O	O
|	O	O	O	O	O	O
egui.exe	O	O	O	O	O	O
|	O	O	O	O	O	O
wdswfsafe.exe	O	O	O	O	O	O
|	O	O	O	O	O	O

|	O	O	O	O	O	O
360tray.exe	O	O	O	O	O	O
|	O	O	O	O	O	O
nod32krn.exe	O	O	O	O	O	O
|	O	O	O	O	O	O
KSafeTray.exe	O	O	O	O	O	O
|	O	O	O	O	O	O

|	O	O	O	O	O	O
superkiller.exe	O	O	O	O	O	O
|	O	O	O	O	O	O
avgrsa.exe	O	O	O	O	O	O
|	O	O	O	O	O	O
dwengine.exe	O	O	O	O	O	O
|	O	O	O	O	O	O

|	O	O	O	O	O	O
360sd.exe	O	O	O	O	O	O
|	O	O	O	O	O	O
avgui.exe	O	O	O	O	O	O
|	O	O	O	O	O	O
dwarkdaemon.exe	O	O	O	O	O	O
|	O	O	O	O	O	O

|	O	O	O	O	O	O
360rps.exe	O	O	O	O	O	O
|	O	O	O	O	O	O
avscan.exe	O	O	O	O	O	O
|	O	O	O	O	O	O
vssery.exe	O	O	O	O	O	O
|	O	O	O	O	O	O

|	O	O	O	O	O	O
QQPCRTP.exe	O	O	O	O	O	O
|	O	O	O	O	O	O
v3svc.exe	O	O	O	O	O	O
|	O	O	O	O	O	O
mfemms.exe	O	O	O	O	O	O
|	O	O	O	O	O	O

|	O	O	O	O	O	O
systemaidbox.exe	O	O	O	O	O	O
|	O	O	O	O	O	O
v3medic.exe	O	O	O	O	O	O
|	O	O	O	O	O	O
 	O	O	O	O	O	O
|	O	O	O	O	O	O

|	O	O	O	O	O	O
avgnt.exe	O	O	O	O	O	O
|	O	O	O	O	O	O
Rtvscan.exe	O	O	O	O	O	O
|	O	O	O	O	O	O
 	O	O	O	O	O	O
|	O	O	O	O	O	O

|	O	O	O	O	O	O
avengine.exe	O	O	O	O	O	O
|	O	O	O	O	O	O
avastsvc.exe	O	O	O	O	O	O
|	O	O	O	O	O	O
 	O	O	O	O	O	O
|	O	O	O	O	O	O

|	O	O	O	O	O	O
msmpeng.exe	O	O	O	O	O	O
|	O	O	O	O	O	O
bdagent.exe	O	O	O	O	O	O
|	O	O	O	O	O	O
 	O	O	O	O	O	O
|	O	O	O	O	O	O

|	O	O	O	O	O	O
nissrv.exe	O	O	O	O	O	O
|	O	O	O	O	O	O
mcshield.exe	O	O	O	O	O	O
|	O	O	O	O	O	O
 	O	O	O	O	O	O
|	O	O	O	O	O	O

|	O	O	O	O	O	O
msseces.exe	O	O	O	O	O	O
|	O	O	O	O	O	O
mcsvhost.exe	O	O	O	O	O	O
|	O	O	O	O	O	O
 	O	O	O	O	O	O
|	O	O	O	O	O	O

|	O	O	O	O	O	O
ccSvcHst.exe	O	O	O	O	O	O
|	O	O	O	O	O	O
mfefire.exe	O	O	O	O	O	O
|	O	O	O	O	O	O
 	O	O	O	O	O	O
|	O	O	O	O	O	O

*	O	O	O	O	O	O
*	O	O	O	O	O	O
Analysis	O	O	O	O	O	O
of	O	O	O	O	O	O
ushellcode1	O	O	O	O	O	O
*	O	O	O	O	O	O
*	O	O	O	O	O	O

This	O	O	O	O	O	O
shellcode	O	O	O	O	O	O
downloads	O	O	O	O	O	O
another	O	O	O	O	O	O
shellcode	O	O	O	O	O	O
and	O	O	O	O	O	O
a	O	O	O	O	O	O
config	O	O	O	O	O	O
file	O	O	O	O	O	O
.	O	O	O	O	O	O

The	O	O	O	O	O	O
config	O	O	O	O	O	O
file	O	O	O	O	O	O
is	O	O	O	O	O	O
encrypted	O	O	O	O	O	O
(	O	O	O	O	O	O
using	O	O	O	O	O	O
simple	O	O	O	O	O	O
XOR	O	O	O	O	O	O
)	O	O	O	O	O	O
and	O	O	O	O	O	O
saved	O	O	O	O	O	O
in	O	O	O	O	O	O
*	O	O	O	O	O	O
C	O	O	O	O	O	O
:	O	O	O	O	O	O
\	O	O	O	O	O	O
Windows	O	O	O	O	O	O
\	O	O	O	O	O	O
Temp	O	O	O	O	O	O
\	O	O	O	O	O	O
ntuser.dat	O	O	O	O	O	O
*	O	O	O	O	O	O
file	O	O	O	O	O	O
.	O	O	O	O	O	O

!	O	O	O	O	O	O
[	O	O	O	O	O	O
]	O	O	O	O	O	O
(	O	O	O	O	O	O
/	O	O	O	O	O	O
cdn-cgi	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
/	O	O	O	O	O	O
format	O	O	O	O	O	O
=	O	O	O	O	O	O
auto	O	O	O	O	O	O
/	O	O	O	O	O	O
sites	O	O	O	O	O	O
/	O	O	O	O	O	O
default	O	O	O	O	O	O
/	O	O	O	O	O	O
files	O	O	O	O	O	O
/	O	O	O	O	O	O
images	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
_	O	O	O	O	O	O
1536860871	O	O	O	O	O	O
.	O	O	O	O	O	O
png	O	O	O	O	O	O
)	O	O	O	O	O	O

Figure	O	O	O	O	O	O
22	O	O	O	O	O	O
:	O	O	O	O	O	O
Downloading	O	O	O	O	O	O
config	O	O	O	O	O	O
file	O	O	O	O	O	O

The	O	O	O	O	O	O
config	O	O	O	O	O	O
file	O	O	O	O	O	O
contains	O	O	O	O	O	O
different	O	O	O	O	O	O
URL	O	O	O	O	O	O
addresses	O	O	O	O	O	O
,	O	O	O	O	O	O
used	O	O	O	O	O	O
to	O	O	O	O	O	O
download	O	O	O	O	O	O
further	O	O	O	O	O	O
shellcodes	O	O	O	O	O	O
and	O	O	O	O	O	O
config	O	O	O	O	O	O
files	O	O	O	O	O	O
.	O	O	O	O	O	O

Content	O	O	O	O	O	O
of	O	O	O	O	O	O
the	O	O	O	O	O	O
config	O	O	O	O	O	O
file	O	O	O	O	O	O
is	O	O	O	O	O	O
shown	O	O	O	O	O	O
in	O	O	O	O	O	O
figure	O	O	O	O	O	O
23	O	O	O	O	O	O
.	O	O	O	O	O	O

For	O	O	O	O	O	O
the	O	O	O	O	O	O
IPs	O	O	O	O	O	O
mentioned	O	O	O	O	O	O
under	O	O	O	O	O	O
the	O	O	O	O	O	O
main	O	O	O	O	O	O
section	O	O	O	O	O	O
,	O	O	O	O	O	O
it	O	O	O	O	O	O
appends	O	O	O	O	O	O
the	O	O	O	O	O	O
“	O	O	O	O	O	O
*	O	O	O	O	O	O
TestMsg.tmp	O	O	O	O	O	O
*	O	O	O	O	O	O
”	O	O	O	O	O	O
string	O	O	O	O	O	O
at	O	O	O	O	O	O
the	O	O	O	O	O	O
end	O	O	O	O	O	O
URL	O	O	O	O	O	O
to	O	O	O	O	O	O
generate	O	O	O	O	O	O
a	O	O	O	O	O	O
full	O	O	O	O	O	O
URL	O	O	O	O	O	O
,	O	O	O	O	O	O
which	O	O	O	O	O	O
serves	O	O	O	O	O	O
as	O	O	O	O	O	O
shellcode	O	O	O	O	O	O
.	O	O	O	O	O	O

Similarly	O	O	O	O	O	O
,	O	O	O	O	O	O
for	O	O	O	O	O	O
all	O	O	O	O	O	O
the	O	O	O	O	O	O
URLs	O	O	O	O	O	O
mentioned	O	O	O	O	O	O
under	O	O	O	O	O	O
section	O	O	O	O	O	O
*	O	O	O	O	O	O
[	O	O	O	O	O	O
update	O	O	O	O	O	O
]	O	O	O	O	O	O
*	O	O	O	O	O	O
as	O	O	O	O	O	O
seen	O	O	O	O	O	O
below	O	O	O	O	O	O
,	O	O	O	O	O	O
it	O	O	O	O	O	O
appends	O	O	O	O	O	O
string	O	O	O	O	O	O
“	O	O	O	O	O	O
*	O	O	O	O	O	O
address.txt	O	O	O	O	O	O
*	O	O	O	O	O	O
”	O	O	O	O	O	O
so	O	O	O	O	O	O
these	O	O	O	O	O	O
URLs	O	O	O	O	O	O
are	O	O	O	O	O	O
used	O	O	O	O	O	O
to	O	O	O	O	O	O
download	O	O	O	O	O	O
the	O	O	O	O	O	O
updated	O	O	O	O	O	O
config	O	O	O	O	O	O
file	O	O	O	O	O	O
.	O	O	O	O	O	O

!	O	O	O	O	O	O
[	O	O	O	O	O	O
]	O	O	O	O	O	O
(	O	O	O	O	O	O
/	O	O	O	O	O	O
cdn-cgi	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
/	O	O	O	O	O	O
format	O	O	O	O	O	O
=	O	O	O	O	O	O
auto	O	O	O	O	O	O
/	O	O	O	O	O	O
sites	O	O	O	O	O	O
/	O	O	O	O	O	O
default	O	O	O	O	O	O
/	O	O	O	O	O	O
files	O	O	O	O	O	O
/	O	O	O	O	O	O
images	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
_	O	O	O	O	O	O
1536860900	O	O	O	O	O	O
.	O	O	O	O	O	O
png	O	O	O	O	O	O
)	O	O	O	O	O	O

Figure	O	O	O	O	O	O
23	O	O	O	O	O	O
:	O	O	O	O	O	O
Config	O	O	O	O	O	O
file	O	O	O	O	O	O
content	O	O	O	O	O	O

The	O	O	O	O	O	O
downloaded	O	O	O	O	O	O
shellcode	O	O	O	O	O	O
continues	O	O	O	O	O	O
to	O	O	O	O	O	O
download	O	O	O	O	O	O
the	O	O	O	O	O	O
final	O	O	O	O	O	O
payload	O	O	O	O	O	O
using	O	O	O	O	O	O
information	O	O	O	O	O	O
from	O	O	O	O	O	O
the	O	O	O	O	O	O
new	O	O	O	O	O	O
config	O	O	O	O	O	O
file	O	O	O	O	O	O
(	O	O	O	O	O	O
figure	O	O	O	O	O	O
24	O	O	O	O	O	O
)	O	O	O	O	O	O
.	O	O	O	O	O	O

The	O	O	O	O	O	O
payload	O	O	O	O	O	O
is	O	O	O	O	O	O
saved	O	O	O	O	O	O
in	O	O	O	O	O	O
the	O	O	O	O	O	O
*	O	O	O	O	O	O
%	O	O	O	O	O	O
SYSTEMROOT	O	O	O	O	O	O
%	O	O	O	O	O	O
\	O	O	O	O	O	O
\	O	O	O	O	O	O
TEMP	O	O	O	O	O	O
*	O	O	O	O	O	O
folder	O	O	O	O	O	O
with	O	O	O	O	O	O
the	O	O	O	O	O	O
name	O	O	O	O	O	O
*	O	O	O	O	O	O
conhost.exe	O	O	O	O	O	O
*	O	O	O	O	O	O
(	O	O	O	O	O	O
figure	O	O	O	O	O	O
25	O	O	O	O	O	O
)	O	O	O	O	O	O
and	O	O	O	O	O	O
executed	O	O	O	O	O	O
with	O	O	O	O	O	O
the	O	O	O	O	O	O
“	O	O	O	O	O	O
-	O	O	O	O	O	O
C	O	O	O	O	O	O
create	O	O	O	O	O	O
-	O	O	O	O	O	O
r	O	O	O	O	O	O
”	O	O	O	O	O	O
parameter	O	O	O	O	O	O
.	O	O	O	O	O	O

!	O	O	O	O	O	O
[	O	O	O	O	O	O
]	O	O	O	O	O	O
(	O	O	O	O	O	O
/	O	O	O	O	O	O
cdn-cgi	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
/	O	O	O	O	O	O
format	O	O	O	O	O	O
=	O	O	O	O	O	O
auto	O	O	O	O	O	O
/	O	O	O	O	O	O
sites	O	O	O	O	O	O
/	O	O	O	O	O	O
default	O	O	O	O	O	O
/	O	O	O	O	O	O
files	O	O	O	O	O	O
/	O	O	O	O	O	O
images	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
_	O	O	O	O	O	O
1536860983	O	O	O	O	O	O
.	O	O	O	O	O	O
png	O	O	O	O	O	O
)	O	O	O	O	O	O

Figure	O	O	O	O	O	O
24	O	O	O	O	O	O
:	O	O	O	O	O	O
new	O	O	O	O	O	O
config	O	O	O	O	O	O
file	O	O	O	O	O	O
contents	O	O	O	O	O	O

!	O	O	O	O	O	O
[	O	O	O	O	O	O
]	O	O	O	O	O	O
(	O	O	O	O	O	O
/	O	O	O	O	O	O
cdn-cgi	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
/	O	O	O	O	O	O
format	O	O	O	O	O	O
=	O	O	O	O	O	O
auto	O	O	O	O	O	O
/	O	O	O	O	O	O
sites	O	O	O	O	O	O
/	O	O	O	O	O	O
default	O	O	O	O	O	O
/	O	O	O	O	O	O
files	O	O	O	O	O	O
/	O	O	O	O	O	O
images	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
_	O	O	O	O	O	O
1536861009	O	O	O	O	O	O
.	O	O	O	O	O	O
png	O	O	O	O	O	O
)	O	O	O	O	O	O

Figure	O	O	O	O	O	O
25	O	O	O	O	O	O
:	O	O	O	O	O	O
Download	O	O	O	O	O	O
of	O	O	O	O	O	O
final	O	O	O	O	O	O
payload	O	O	O	O	O	O

*	O	O	O	O	O	O
*	O	O	O	O	O	O
Analysis	O	O	O	O	O	O
of	O	O	O	O	O	O
payload	O	O	O	O	O	O
*	O	O	O	O	O	O
*	O	O	O	O	O	O

This	O	O	O	O	O	O
payload	O	O	O	O	O	O
works	O	O	O	O	O	O
as	O	O	O	O	O	O
a	O	O	O	O	O	O
downloader	O	O	O	O	O	O
.	O	O	O	O	O	O

During	O	O	O	O	O	O
our	O	O	O	O	O	O
analysis	O	O	O	O	O	O
,	O	O	O	O	O	O
we	O	O	O	O	O	O
found	O	O	O	O	O	O
it	O	O	O	O	O	O
downloading	O	O	O	O	O	O
a	O	O	O	O	O	O
cryptomining	O	O	O	O	O	O
tool	O	O	O	O	O	O
.	O	O	O	O	O	O

It	O	O	O	O	O	O
registers	O	O	O	O	O	O
itself	O	O	O	O	O	O
as	O	O	O	O	O	O
a	O	O	O	O	O	O
Windows	O	O	O	O	O	O
service	O	O	O	O	O	O
with	O	O	O	O	O	O
name	O	O	O	O	O	O
“	O	O	O	O	O	O
Windows	O	O	O	O	O	O
Audio	O	O	O	O	O	O
Control	O	O	O	O	O	O
.	O	O	O	O	O	O

It	O	O	O	O	O	O
supports	O	O	O	O	O	O
different	O	O	O	O	O	O
command	O	O	O	O	O	O
line	O	O	O	O	O	O
options	O	O	O	O	O	O
(	O	O	O	O	O	O
figure	O	O	O	O	O	O
26	O	O	O	O	O	O
)	O	O	O	O	O	O
,	O	O	O	O	O	O
including	O	O	O	O	O	O
the	O	O	O	O	O	O
main	O	O	O	O	O	O
ones	O	O	O	O	O	O
:	O	O	O	O	O	O
Create	O	O	O	O	O	O
,	O	O	O	O	O	O
delete	O	O	O	O	O	O
,	O	O	O	O	O	O
start	O	O	O	O	O	O
,	O	O	O	O	O	O
and	O	O	O	O	O	O
stop	O	O	O	O	O	O
services	O	O	O	O	O	O
.	O	O	O	O	O	O

!	O	O	O	O	O	O
[	O	O	O	O	O	O
]	O	O	O	O	O	O
(	O	O	O	O	O	O
/	O	O	O	O	O	O
cdn-cgi	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
/	O	O	O	O	O	O
format	O	O	O	O	O	O
=	O	O	O	O	O	O
auto	O	O	O	O	O	O
/	O	O	O	O	O	O
sites	O	O	O	O	O	O
/	O	O	O	O	O	O
default	O	O	O	O	O	O
/	O	O	O	O	O	O
files	O	O	O	O	O	O
/	O	O	O	O	O	O
images	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
_	O	O	O	O	O	O
1536861047	O	O	O	O	O	O
.	O	O	O	O	O	O
png	O	O	O	O	O	O
)	O	O	O	O	O	O

Figure	O	O	O	O	O	O
26	O	O	O	O	O	O
:	O	O	O	O	O	O
Different	O	O	O	O	O	O
command	O	O	O	O	O	O
line	O	O	O	O	O	O
options	O	O	O	O	O	O
.	O	O	O	O	O	O

Upon	O	O	O	O	O	O
executing	O	O	O	O	O	O
without	O	O	O	O	O	O
any	O	O	O	O	O	O
command	O	O	O	O	O	O
,	O	O	O	O	O	O
it	O	O	O	O	O	O
first	O	O	O	O	O	O
downloads	O	O	O	O	O	O
*	O	O	O	O	O	O
xpxmr.dat	O	O	O	O	O	O
*	O	O	O	O	O	O
file	O	O	O	O	O	O
that	O	O	O	O	O	O
contains	O	O	O	O	O	O
a	O	O	O	O	O	O
list	O	O	O	O	O	O
of	O	O	O	O	O	O
C	O	O	O	O	O	O
&	O	O	O	O	O	O
C	O	O	O	O	O	O
IP	O	O	O	O	O	O
addresses	O	O	O	O	O	O
and	O	O	O	O	O	O
URLs	O	O	O	O	O	O
.	O	O	O	O	O	O
This	O	O	O	O	O	O
config	O	O	O	O	O	O
file	O	O	O	O	O	O
is	O	O	O	O	O	O
saved	O	O	O	O	O	O
in	O	O	O	O	O	O
the	O	O	O	O	O	O
*	O	O	O	O	O	O
C	O	O	O	O	O	O
:	O	O	O	O	O	O
\	O	O	O	O	O	O
Program	O	O	O	O	O	O
Files	O	O	O	O	O	O
\	O	O	O	O	O	O
Common	O	O	O	O	O	O
Files	O	O	O	O	O	O
*	O	O	O	O	O	O
folder	O	O	O	O	O	O
.	O	O	O	O	O	O

It	O	O	O	O	O	O
also	O	O	O	O	O	O
downloads	O	O	O	O	O	O
the	O	O	O	O	O	O
below	O	O	O	O	O	O
config	O	O	O	O	O	O
files	O	O	O	O	O	O
:	O	O	O	O	O	O

|	O	O	O	O	O	O
File	O	O	O	O	O	O
Name	O	O	O	O	O	O
|	O	O	O	O	O	O
Description	O	O	O	O	O	O
|	O	O	O	O	O	O

|	O	O	O	O	O	O
ver.txt	O	O	O	O	O	O
|	O	O	O	O	O	O
Contains	O	O	O	O	O	O
new	O	O	O	O	O	O
version	O	O	O	O	O	O
of	O	O	O	O	O	O
the	O	O	O	O	O	O
malware	O	O	O	O	O	O
payload	O	O	O	O	O	O
;	O	O	O	O	O	O
if	O	O	O	O	O	O
it	O	O	O	O	O	O
does	O	O	O	O	O	O
not	O	O	O	O	O	O
match	O	O	O	O	O	O
the	O	O	O	O	O	O
current	O	O	O	O	O	O
version	O	O	O	O	O	O
,	O	O	O	O	O	O
a	O	O	O	O	O	O
new	O	O	O	O	O	O
version	O	O	O	O	O	O
will	O	O	O	O	O	O
be	O	O	O	O	O	O
downloaded	O	O	O	O	O	O
|	O	O	O	O	O	O

|	O	O	O	O	O	O
/	O	O	O	O	O	O
ok	O	O	O	O	O	O
/	O	O	O	O	O	O
down.html	O	O	O	O	O	O
|	O	O	O	O	O	O
Receives	O	O	O	O	O	O
the	O	O	O	O	O	O
URL	O	O	O	O	O	O
for	O	O	O	O	O	O
downloading	O	O	O	O	O	O
additional	O	O	O	O	O	O
malware	O	O	O	O	O	O
payloads	O	O	O	O	O	O
|	O	O	O	O	O	O

|	O	O	O	O	O	O
kill.txt	O	O	O	O	O	O
|	O	O	O	O	O	O
This	O	O	O	O	O	O
file	O	O	O	O	O	O
contains	O	O	O	O	O	O
the	O	O	O	O	O	O
name	O	O	O	O	O	O
of	O	O	O	O	O	O
processes	O	O	O	O	O	O
to	O	O	O	O	O	O
terminate	O	O	O	O	O	O
and	O	O	O	O	O	O
file	O	O	O	O	O	O
paths	O	O	O	O	O	O
to	O	O	O	O	O	O
delete	O	O	O	O	O	O
|	O	O	O	O	O	O

*	O	O	O	O	O	O
*	O	O	O	O	O	O
Zscaler	B-ORG	O	O	O	O	B-ORG
Coverage	O	O	O	O	O	O
*	O	O	O	O	O	O
*	O	O	O	O	O	O

Zscaler	B-ORG	O	O	O	O	B-ORG
detects	O	O	O	O	O	O
this	O	O	O	O	O	O
threat	O	O	O	O	O	O
via	O	O	O	O	O	O
following	O	O	O	O	O	O
signatures	O	O	O	O	O	O
:	O	O	O	O	O	O

W64	O	O	O	O	O	O
/	O	O	O	O	O	O
Trojan.TOKZ	O	O	O	O	O	O
-	O	O	O	O	O	O
7175	O	O	O	O	O	O

Win32	O	O	O	O	O	O
.	O	O	O	O	O	O
Coinminer.Agent.LZ	O	O	O	O	O	O

Win32	O	O	O	O	O	O
.	O	O	O	O	O	O
Trojan.Darkcloud.LZ	O	O	O	O	O	O

Cloud	O	O	O	O	O	O
Sandbox	O	O	O	O	O	O
Report	O	O	O	O	O	O
showing	O	O	O	O	O	O
the	O	O	O	O	O	O
detonation	O	O	O	O	O	O
activity	O	O	O	O	O	O
for	O	O	O	O	O	O
this	O	O	O	O	O	O
malware	O	O	O	O	O	O
can	O	O	O	O	O	O
be	O	O	O	O	O	O
seen	O	O	O	O	O	O
below	O	O	O	O	O	O
:	O	O	O	O	O	O

!	O	O	O	O	O	O
[	O	O	O	O	O	O
]	O	O	O	O	O	O
(	O	O	O	O	O	O
/	O	O	O	O	O	O
cdn-cgi	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
/	O	O	O	O	O	O
format	O	O	O	O	O	O
=	O	O	O	O	O	O
auto	O	O	O	O	O	O
/	O	O	O	O	O	O
sites	O	O	O	O	O	O
/	O	O	O	O	O	O
default	O	O	O	O	O	O
/	O	O	O	O	O	O
files	O	O	O	O	O	O
/	O	O	O	O	O	O
images	O	O	O	O	O	O
/	O	O	O	O	O	O
image	O	O	O	O	O	O
_	O	O	O	O	O	O
1536861145	O	O	O	O	O	O
.	O	O	O	O	O	O
png	O	O	O	O	O	O
)	O	O	O	O	O	O

